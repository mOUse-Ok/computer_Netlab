/**
 * ============================================================================
 * 配置文件：config.h
 * ============================================================================
 * 描述：集中管理所有与传输效率相关的可配置参数
 * 说明：
 *   - 所有参数都可以根据测试需要进行调整
 *   - 每个参数都包含：含义、修改方法、修改后可能出现的效果
 *   - 修改后需要重新编译 client.cpp 和 server.cpp
 * 
 * 作者：Lab2 Project
 * 日期：2025-12-10
 * ============================================================================
 */

#ifndef CONFIG_H
#define CONFIG_H

// ============================================================================
// 一、网络连接基础参数
// ============================================================================

/**
 * 服务端监听端口
 * 含义：服务端绑定并监听的UDP端口号
 * 修改方法：直接修改数值，范围建议1024-65535（避免使用系统保留端口）
 * 修改效果：
 *   - 客户端需要同步修改SERVER_PORT才能连接
 *   - 不影响传输效率，仅影响网络配置
 *   - 如果端口被占用，服务端启动会失败
 */
#define PORT 8888

/**
 * 服务端端口（客户端使用）
 * 含义：客户端连接的目标端口
 * 修改方法：必须与服务端PORT保持一致
 * 修改效果：
 *   - 与PORT不一致会导致连接失败
 */
#define SERVER_PORT 8888

/**
 * 服务端IP地址
 * 含义：客户端连接的服务端IP
 * 修改方法：修改为目标服务器IP，如"192.168.1.100"
 * 修改效果：
 *   - "127.0.0.1"：本地回环测试，无网络延迟
 *   - 局域网IP：增加少量网络延迟
 *   - 公网IP：需要确保端口可访问，延迟更大
 */
#define SERVER_IP "127.0.0.1"


// ============================================================================
// 二、协议数据包参数
// ============================================================================

/**
 * 协议头大小（字节）
 * 含义：每个数据包的协议头固定占用20字节
 * 修改方法：【不建议修改】修改需要同步调整UDPHeader结构体
 * 修改效果：
 *   - 修改会导致协议不兼容
 *   - 增大：减少有效数据负载比例，降低传输效率
 *   - 减小：可能丢失必要的控制信息
 */
#define HEADER_SIZE 20

/**
 * 最大数据包大小（字节）
 * 含义：单个UDP数据包的最大总长度（协议头+数据）
 * 修改方法：建议在512-1472之间调整（1472=1500MTU-28IP/UDP头）
 * 修改效果：
 *   - 增大（如1400）：
 *     * 每个包携带更多数据，减少包数量
 *     * 超过MTU会导致IP分片，可能增加丢包率
 *   - 减小（如512）：
 *     * 更多小包，增加网络开销
 *     * 降低单包丢失的影响
 */
#define MAX_PACKET_SIZE 8192

/**
 * 最大数据负载大小（字节）
 * 含义：每个数据包中实际数据部分的最大长度
 * 修改方法：自动计算，无需手动修改
 * 说明：MAX_DATA_SIZE = MAX_PACKET_SIZE - HEADER_SIZE
 */
#define MAX_DATA_SIZE (MAX_PACKET_SIZE - HEADER_SIZE)


// ============================================================================
// 三、滑动窗口与流量控制参数（重要！影响传输效率）
// ============================================================================

/**
 * 默认窗口大小
 * 含义：协议头中携带的默认窗口大小值
 * 修改方法：通常保持与FIXED_WINDOW_SIZE一致
 * 修改效果：
 *   - 仅影响协议头字段的默认值
 */
#define DEFAULT_WINDOW_SIZE 32

/**
 * 固定窗口大小（关键参数）
 * 含义：接收窗口的大小（单位：数据包数量）
 * 修改方法：建议范围2-16，根据网络条件调整
 * 修改效果：
 *   - 增大（如8或16）：
 *     * 允许更多未确认的包在传输中，提高吞吐量
 *     * 网络拥塞时可能导致大量丢包和重传
 *     * 占用更多发送/接收缓冲区内存
 *   - 减小（如2）：
 *     * 发送更保守，降低丢包风险
 *     * 限制了并行发送的包数，降低吞吐量
 *     * 在高延迟网络中效率很低
 * 
 * 测试建议：
 *   - 本地测试：4-8 效果较好
 *   - 高延迟网络：适当增大到8-16
 *   - 丢包率高的网络：适当减小到2-4
 */
#define FIXED_WINDOW_SIZE 32

/**
 * 最大报文段大小（MSS）
 * 含义：数据缓冲区的单位大小
 * 修改方法：保持与MAX_DATA_SIZE一致
 * 修改效果：
 *   - 影响窗口内数据缓冲区的分配
 */
#define MSS MAX_DATA_SIZE


// ============================================================================
// 四、超时与重传参数（重要！影响可靠性和效率）
// ============================================================================

/**
 * 连接超时时间（毫秒）
 * 含义：三次握手、四次挥手中等待响应的超时时间
 * 修改方法：建议范围1000-10000ms
 * 修改效果：
 *   - 增大（如5000ms）：
 *     * 对高延迟网络更宽容
 *     * 连接建立/关闭变慢
 *   - 减小（如1000ms）：
 *     * 更快检测连接失败
 *     * 在高延迟网络中可能误判超时
 */
#define TIMEOUT_MS 3000

/**
 * 最大重传次数
 * 含义：发送包超时后的最大重传尝试次数
 * 修改方法：建议范围3-10
 * 修改效果：
 *   - 增大（如10）：
 *     * 更努力尝试发送成功，提高可靠性
 *     * 失败时等待时间更长
 *   - 减小（如1-2）：
 *     * 更快放弃重传
 *     * 可能降低传输成功率
 */
#define MAX_RETRIES 3

/**
 * TIME_WAIT状态等待时间（毫秒）
 * 含义：连接关闭后客户端等待的时间（模拟TCP的2*MSL）
 * 修改方法：建议范围2000-10000ms
 * 修改效果：
 *   - 增大：确保旧连接的包不会影响新连接
 *   - 减小：更快释放连接资源，但可能导致端口复用问题
 */
#define TIME_WAIT_MS 4000

/**
 * 连接空闲超时（毫秒）
 * 含义：无数据传输时判断连接断开的时间
 * 修改方法：建议范围3000-30000ms
 * 修改效果：
 *   - 增大：更宽容暂时的网络中断
 *   - 减小：更快清理空闲连接
 */
#define CONNECTION_TIMEOUT_MS 500

/**
 * SACK超时重传时间（毫秒）（关键参数）
 * 含义：选择性确认机制中，未收到ACK时触发重传的等待时间
 * 修改方法：建议范围200-2000ms
 * 修改效果：
 *   - 增大（如1000ms）：
 *     * 等待更长时间再重传，减少不必要的重传
 *     * 真正丢包时恢复较慢
 *   - 减小（如200ms）：
 *     * 更快检测丢包并重传，提高响应速度
 *     * 可能导致过早重传（实际包还在路上）
 * 
 * 测试建议：
 *   - 本地测试：200-500ms
 *   - 广域网：1000-2000ms
 */
#define SACK_TIMEOUT_MS 500

/**
 * 最大SACK块数量
 * 含义：一个ACK包中最多携带的选择确认块数量
 * 修改方法：建议范围2-8
 * 修改效果：
 *   - 增大：携带更多乱序接收信息，帮助发送端精确重传
 *   - 减小：减少ACK包大小，但可能丢失部分信息
 */
#define MAX_SACK_BLOCKS 4


// ============================================================================
// 五、TCP RENO 拥塞控制参数（重要！影响拥塞响应）
// ============================================================================

/**
 * 初始拥塞窗口大小（cwnd）
 * 含义：连接建立后或超时后拥塞窗口的初始值
 * 修改方法：建议范围1-4
 * 修改效果：
 *   - 增大（如4）：
 *     * 一开始就能发送更多包，加快慢启动过程
 *     * 可能在网络状况不明时造成拥塞
 *   - 保持为1：
 *     * 标准的慢启动行为，最保守
 * 
 * 说明：现代TCP（如Linux）初始cwnd通常为10
 */
#define INITIAL_CWND 1

/**
 * 初始慢启动阈值（ssthresh）
 * 含义：慢启动和拥塞避免阶段的切换点
 * 修改方法：建议范围8-64
 * 修改效果：
 *   - 增大（如64）：
 *     * 慢启动阶段持续更长，cwnd增长更快
 *     * 可能过度增长导致突然拥塞
 *   - 减小（如8）：
 *     * 更快进入拥塞避免阶段，增长更平缓
 *     * 达到最大吞吐量需要更长时间
 * 
 * 建议：初始值设较大（如32），让算法自己调整
 */
#define INITIAL_SSTHRESH 16

/**
 * 最小慢启动阈值
 * 含义：ssthresh的最小允许值，防止过度降低
 * 修改方法：建议范围1-4
 * 修改效果：
 *   - 保证即使多次丢包，ssthresh也不会过低
 */
#define MIN_SSTHRESH 2

/**
 * 重复ACK阈值（快速重传触发条件）
 * 含义：收到多少个重复ACK后触发快速重传
 * 修改方法：标准值为3，一般不建议修改
 * 修改效果：
 *   - 增大（如5）：
 *     * 更确定是丢包而非乱序，减少不必要的重传
 *     * 检测丢包更慢
 *   - 减小（如2）：
 *     * 更快触发重传
 *     * 可能因乱序产生误判
 */
#define DUP_ACK_THRESHOLD 3


// ============================================================================
// 六、丢包模拟参数（用于测试和调试）
// ============================================================================

/**
 * 是否启用丢包模拟
 * 含义：服务端是否模拟随机丢弃数据包
 * 修改方法：
 *   - true：启用丢包模拟，用于测试SACK和重传机制
 *   - false：关闭丢包模拟，正常传输
 * 修改效果：
 *   - 启用时：根据 SIMULATE_LOSS_RATE 概率随机丢弃数据包
 *   - 关闭时：所有包正常处理
 */
#define SIMULATE_LOSS_ENABLED true

/**
 * 丢包率（百分比，0-100）
 * 含义：模拟丢包的概率百分比
 * 修改方法：直接修改数值，范围0-100
 * 修改效果：
 *   - 0：不丢包
 *   - 10：约10%的包会被丢弃
 *   - 50：约50%的包会被丢弃（测试极端情况）
 * 测试建议：
 *   - 正常测试：5-15%
 *   - 压力测试：20-30%
 */
#define SIMULATE_LOSS_RATE 5

/**
 * 是否启用延迟模拟
 * 含义：服务端是否模拟网络延迟
 * 修改方法：
 *   - true：启用延迟模拟
 *   - false：关闭延迟模拟，无额外延迟
 * 修改效果：
 *   - 启用时：每个收到的包会延迟 SIMULATE_DELAY_MS 毫秒后处理
 *   - 关闭时：立即处理数据包
 */
#define SIMULATE_DELAY_ENABLED true

/**
 * 模拟延迟时间（毫秒）
 * 含义：模拟网络延迟的时间
 * 修改方法：直接修改数值，单位为毫秒
 * 修改效果：
 *   - 0：无延迟
 *   - 50：模拟50ms的网络延迟
 *   - 200：模拟较高延迟的广域网环境
 * 测试建议：
 *   - 本地测试：0-50ms
 *   - 模拟广域网：100-300ms
 */
#define SIMULATE_DELAY_MS 5


// ============================================================================
// 七、调试相关参数
// ============================================================================

/**
 * 接收等待超时（服务端流水线接收）
 * 含义：等待数据包的超时时间
 * 修改方法：在server.cpp中修改pipelineRecv函数的timeout变量
 * 当前值：5000ms
 */
// int timeout = 5000;  // 在server.cpp pipelineRecv函数中

/**
 * 空闲计数阈值（服务端流水线接收）
 * 含义：连续超时多少次后认为接收完成
 * 修改方法：在server.cpp中修改maxIdleCount变量
 * 当前值：3次
 */
// int maxIdleCount = 3;  // 在server.cpp pipelineRecv函数中

/**
 * ACK轮询超时（客户端流水线发送）
 * 含义：等待ACK的短超时时间，用于轮询检查
 * 修改方法：在client.cpp中修改timeout变量
 * 当前值：100ms
 * 修改效果：
 *   - 减小：更频繁地检查ACK和超时，CPU开销增加
 *   - 增大：检查频率降低，但可能延迟发现丢包
 */
// int timeout = 100;  // 在client.cpp pipelineSend函数中


// ============================================================================
// 参数调优建议总结
// ============================================================================
/**
 * 场景1：本地回环测试（延迟极低）
 *   - FIXED_WINDOW_SIZE: 4-8
 *   - SACK_TIMEOUT_MS: 200-500
 *   - INITIAL_SSTHRESH: 32
 *   - 可启用丢包模拟测试SACK功能
 * 
 * 场景2：局域网测试（延迟较低，10-50ms）
 *   - FIXED_WINDOW_SIZE: 8-16
 *   - SACK_TIMEOUT_MS: 500-1000
 *   - TIMEOUT_MS: 3000-5000
 * 
 * 场景3：广域网测试（延迟较高，100-300ms）
 *   - FIXED_WINDOW_SIZE: 16-32
 *   - SACK_TIMEOUT_MS: 1000-2000
 *   - TIMEOUT_MS: 5000-10000
 *   - INITIAL_SSTHRESH: 64
 * 
 * 场景4：高丢包率网络测试
 *   - FIXED_WINDOW_SIZE: 2-4（减少窗口避免大量重传）
 *   - MAX_RETRIES: 5-10（增加重传次数）
 *   - SACK_TIMEOUT_MS: 300-500（快速检测丢包）
 */

#endif // CONFIG_H
